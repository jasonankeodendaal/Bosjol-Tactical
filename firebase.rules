rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // Helper Functions
    // ---------------------------

    // Checks if the requesting user is an authenticated admin.
    // Assumes an 'admins' collection where document IDs match Firebase Auth UIDs.
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ---------------------------
    // Default Security Rule
    // ---------------------------
    
    // By default, deny all reads and writes to all documents.
    match /{document=**} {
      allow read, write: if false;
    }

    // ---------------------------
    // Public & System Collections
    // (Readable by anyone, only writable by admins)
    // ---------------------------

    // System configuration for progression
    match /ranks/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /badges/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /legendaryBadges/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /gamificationSettings/{docId} { allow read: if true; allow write: if isAdmin(); }

    // Public-facing content
    match /sponsors/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /locations/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /socialLinks/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /carouselMedia/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /raffles/{docId} { allow read: if true; allow write: if isAdmin(); }
    
    // Players need to read inventory to see available rental gear.
    match /inventory/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Global app settings
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ---------------------------
    // Core Operational Collections
    // ---------------------------

    // Players collection: Publicly readable for leaderboards and profiles.
    // Only admins can create, update, or delete player data.
    match /players/{playerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Events collection: Publicly readable for event lists.
    // IMPORTANT: Only admins can write. This secures the data but will
    // prevent the client-side player signup feature from working.
    match /events/{eventId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // ---------------------------
    // Admin-Only Collections
    // ---------------------------

    // Admins collection can only be managed by other admins.
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }

    // These collections contain sensitive or internal data.
    match /suppliers/{docId} { allow read, write: if isAdmin(); }
    match /transactions/{docId} { allow read, write: if isAdmin(); }
    match /vouchers/{docId} { allow read, write: if isAdmin(); }
    
    // ---------------------------
    // Utility Collections
    // ---------------------------
    
    // Used by the System Scanner for health checks by admins/creators.
    match /_system_health_check/{docId} {
      allow read, write: if isAdmin();
    }
  }
}