rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---

    // isAdmin: Checks if the signed-in user is the designated administrator by their email.
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'bosjoltactical@gmail.com';
    }

    // isCreator: Checks if the signed-in user is the designated creator by their email.
    function isCreator() {
      return request.auth != null && request.auth.token.email == 'jstypme@gmail.com';
    }

    // --- Default Security Posture ---

    // By default, deny all reads and writes to the entire database.
    match /{document=**} {
      allow read, write: if false;
    }

    // --- Publicly Readable Collections ---
    // These must be readable by anyone (including unauthenticated players)
    // for the dashboard to function. Write access is strictly limited.
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /socialLinks/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /carouselMedia/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /players/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /events/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /ranks/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /badges/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /legendaryBadges/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /gamificationSettings/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /sponsors/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /inventory/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /suppliers/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /locations/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /raffles/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    match /vouchers/{docId} {
      allow read: if true;
      allow write: if isAdmin() || isCreator();
    }
    
    // --- Admin-Only Collections ---

    // The 'transactions' collection contains sensitive financial data.
    match /transactions/{transactionId} {
      allow read, write: if isAdmin() || isCreator(); 
    }

    // The 'admins' collection contains admin user data.
    match /admins/{adminId} {
      allow read, write: if isAdmin() || isCreator();
    }
    
    // --- Special Rules ---
    
    // The _health collection is used for the System Scanner's R/W test.
    // It requires an authenticated Admin or Creator session.
    match /_health/{testId} {
        allow read, write: if isAdmin() || isCreator();
    }
  }
}}
